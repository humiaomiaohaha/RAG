# =============================================================================
# åŒ»ç–—çŸ¥è¯†RAGç³»ç»Ÿ - Flaskåç«¯åº”ç”¨ä¸»æ–‡ä»¶
# åŠŸèƒ½ï¼šæä¾›RESTful APIæœåŠ¡ï¼Œå¤„ç†ç”¨æˆ·æŸ¥è¯¢è¯·æ±‚ï¼Œç®¡ç†RAGç³»ç»Ÿç”Ÿå‘½å‘¨æœŸ
# ä½œè€…ï¼šAIåŠ©æ‰‹
# æ—¥æœŸï¼š2024å¹´
# =============================================================================

# å¯¼å…¥Flaskæ¡†æ¶ç›¸å…³æ¨¡å—
from flask import Flask, request, jsonify, render_template
from flask_cors import CORS  # å¤„ç†è·¨åŸŸè¯·æ±‚
import json  # JSONæ•°æ®å¤„ç†
import os    # æ“ä½œç³»ç»Ÿæ¥å£

# æ™ºèƒ½å¯¼å…¥RAGç³»ç»Ÿæ¨¡å— - å®ç°è‡ªåŠ¨é™çº§æœºåˆ¶
try:
    # å°è¯•å¯¼å…¥å®Œæ•´çš„RAGç³»ç»Ÿï¼ˆéœ€è¦æ·±åº¦å­¦ä¹ æ¨¡å‹ï¼‰
    from rag_system import MedicalRAGSystem
    USE_SIMPLE_RAG = False  # æ ‡è®°ä½¿ç”¨å®Œæ•´RAGç³»ç»Ÿ
    print("âœ… æˆåŠŸå¯¼å…¥å®Œæ•´RAGç³»ç»Ÿ")
except ImportError:
    # å¦‚æœå®Œæ•´RAGç³»ç»Ÿå¯¼å…¥å¤±è´¥ï¼Œä½¿ç”¨ç®€åŒ–ç‰ˆæœ¬ï¼ˆåŸºäºå…³é”®è¯åŒ¹é…ï¼‰
    from simple_rag_system import SimpleMedicalRAGSystem
    USE_SIMPLE_RAG = True   # æ ‡è®°ä½¿ç”¨ç®€åŒ–RAGç³»ç»Ÿ
    print("âš ï¸ å®Œæ•´RAGç³»ç»Ÿå¯¼å…¥å¤±è´¥ï¼Œä½¿ç”¨ç®€åŒ–ç‰ˆæœ¬")

# =============================================================================
# Flaskåº”ç”¨åˆå§‹åŒ–
# =============================================================================

# åˆ›å»ºFlaskåº”ç”¨å®ä¾‹
app = Flask(__name__)

# å¯ç”¨è·¨åŸŸèµ„æºå…±äº«(CORS) - å…è®¸å‰ç«¯é¡µé¢è°ƒç”¨åç«¯API
CORS(app)

# å…¨å±€å˜é‡ï¼šå­˜å‚¨RAGç³»ç»Ÿå®ä¾‹
# åœ¨æ•´ä¸ªåº”ç”¨ç”Ÿå‘½å‘¨æœŸä¸­ä¿æŒå•ä¸€å®ä¾‹ï¼Œé¿å…é‡å¤åˆå§‹åŒ–
rag_system = None

# =============================================================================
# RAGç³»ç»Ÿåˆå§‹åŒ–å‡½æ•°
# åŠŸèƒ½ï¼šæ ¹æ®ç¯å¢ƒæƒ…å†µé€‰æ‹©åˆé€‚çš„RAGç³»ç»Ÿå®ç°ï¼ŒåŠ è½½æ•°æ®ï¼Œåˆ›å»ºç´¢å¼•
# =============================================================================

def initialize_rag():
    """
    åˆå§‹åŒ–RAGï¼ˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰ç³»ç»Ÿ

    è¯¥å‡½æ•°è´Ÿè´£ï¼š
    1. æ ¹æ®ç¯å¢ƒæƒ…å†µé€‰æ‹©å®Œæ•´RAGç³»ç»Ÿæˆ–ç®€åŒ–RAGç³»ç»Ÿ
    2. ç¡®ä¿åŒ»ç–—æ•°æ®æ–‡ä»¶å­˜åœ¨
    3. åŠ è½½æ–‡æ¡£æ•°æ®
    4. åˆ›å»ºå‘é‡ç´¢å¼•ï¼ˆä»…å®Œæ•´RAGç³»ç»Ÿï¼‰
    5. å¤„ç†å„ç§å¼‚å¸¸æƒ…å†µ

    è¿”å›ï¼š
        bool: åˆå§‹åŒ–æˆåŠŸè¿”å›Trueï¼Œå¤±è´¥è¿”å›False
    """
    global rag_system  # å£°æ˜ä½¿ç”¨å…¨å±€å˜é‡

    try:
        # æ ¹æ®å¯¼å…¥æƒ…å†µé€‰æ‹©RAGç³»ç»Ÿç±»å‹
        if USE_SIMPLE_RAG:
            # ä½¿ç”¨ç®€åŒ–RAGç³»ç»Ÿ - åŸºäºå…³é”®è¯åŒ¹é…ï¼Œæ— éœ€æ·±åº¦å­¦ä¹ æ¨¡å‹
            print("ğŸ”§ ä½¿ç”¨ç®€åŒ–RAGç³»ç»Ÿï¼ˆå…³é”®è¯åŒ¹é…æ¨¡å¼ï¼‰...")
            rag_system = SimpleMedicalRAGSystem()
        else:
            # ä½¿ç”¨å®Œæ•´RAGç³»ç»Ÿ - åŸºäºå‘é‡æ£€ç´¢å’Œæ·±åº¦å­¦ä¹ æ¨¡å‹
            print("ğŸš€ ä½¿ç”¨å®Œæ•´RAGç³»ç»Ÿï¼ˆå‘é‡æ£€ç´¢æ¨¡å¼ï¼‰...")
            # é…ç½®DeepSeek APIå¯†é’¥å’Œæœ¬åœ°embeddingæ¨¡å‹è·¯å¾„
            rag_system = MedicalRAGSystem(
                model_path="D:\\Embedding\\Embedding",  # æœ¬åœ°embeddingæ¨¡å‹è·¯å¾„
                deepseek_api_key="sk-b87c9bf17adf4c5d935feb2748534da4"  # DeepSeek APIå¯†é’¥
            )

        # =============================================================================
        # æ•°æ®æ–‡ä»¶æ£€æŸ¥å’Œç”Ÿæˆ
        # =============================================================================

        # æ£€æŸ¥åŒ»ç–—æ•°æ®æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™è‡ªåŠ¨ç”Ÿæˆ
        if not os.path.exists("medical_docs.json"):
            print("ğŸ“Š åŒ»ç–—æ•°æ®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ­£åœ¨ç”Ÿæˆç¤ºä¾‹æ•°æ®...")
            from data_generator import generate_medical_data
            generate_medical_data()
            print("âœ… ç¤ºä¾‹æ•°æ®ç”Ÿæˆå®Œæˆ")
        else:
            print("âœ… åŒ»ç–—æ•°æ®æ–‡ä»¶å·²å­˜åœ¨")

        # =============================================================================
        # æ–‡æ¡£æ•°æ®åŠ è½½
        # =============================================================================

        # åŠ è½½åŒ»ç–—æ–‡æ¡£æ•°æ®åˆ°RAGç³»ç»Ÿ
        print("ğŸ“š æ­£åœ¨åŠ è½½åŒ»ç–—æ–‡æ¡£æ•°æ®...")
        rag_system.load_documents()
        print("âœ… æ–‡æ¡£æ•°æ®åŠ è½½å®Œæˆ")

        # =============================================================================
        # å‘é‡ç´¢å¼•ç®¡ç†ï¼ˆä»…å®Œæ•´RAGç³»ç»Ÿï¼‰
        # =============================================================================

        if not USE_SIMPLE_RAG:
            # æ£€æŸ¥æ˜¯å¦å·²æœ‰ä¿å­˜çš„å‘é‡ç´¢å¼•æ–‡ä»¶
            if os.path.exists("faiss_index.pkl"):
                print("ğŸ”„ å‘ç°å·²å­˜åœ¨çš„å‘é‡ç´¢å¼•ï¼Œæ­£åœ¨åŠ è½½...")
                rag_system.load_index()
                print("âœ… å‘é‡ç´¢å¼•åŠ è½½å®Œæˆ")
            else:
                print("ğŸ”¨ æœªå‘ç°å‘é‡ç´¢å¼•ï¼Œæ­£åœ¨åˆ›å»ºæ–°çš„ç´¢å¼•...")
                rag_system.create_vector_index()  # åˆ›å»ºFAISSå‘é‡ç´¢å¼•
                rag_system.save_index()           # ä¿å­˜ç´¢å¼•åˆ°æ–‡ä»¶
                print("âœ… å‘é‡ç´¢å¼•åˆ›å»ºå¹¶ä¿å­˜å®Œæˆ")

        print("ğŸ‰ RAGç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ")
        return True

    except Exception as e:
        # =============================================================================
        # å¼‚å¸¸å¤„ç†å’Œé™çº§æœºåˆ¶
        # =============================================================================

        print(f"âŒ RAGç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥: {str(e)}")
        print("ğŸ”„ æ­£åœ¨å°è¯•é™çº§åˆ°ç®€åŒ–RAGç³»ç»Ÿ...")

        try:
            # å°è¯•ä½¿ç”¨ç®€åŒ–RAGç³»ç»Ÿä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆ
            from simple_rag_system import SimpleMedicalRAGSystem
            rag_system = SimpleMedicalRAGSystem()

            # ç¡®ä¿æ•°æ®æ–‡ä»¶å­˜åœ¨
            if not os.path.exists("medical_docs.json"):
                print("ğŸ“Š æ­£åœ¨ç”Ÿæˆç¤ºä¾‹æ•°æ®...")
                from data_generator import generate_medical_data
                generate_medical_data()

            # åŠ è½½æ–‡æ¡£æ•°æ®
            print("ğŸ“š æ­£åœ¨åŠ è½½æ–‡æ¡£æ•°æ®...")
            rag_system.load_documents()
            print("âœ… ç®€åŒ–RAGç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ")
            return True

        except Exception as e2:
            print(f"âŒ ç®€åŒ–RAGç³»ç»Ÿä¹Ÿåˆå§‹åŒ–å¤±è´¥: {str(e2)}")
            print("ğŸ’¡ å»ºè®®æ£€æŸ¥ï¼š")
            print("   1. Pythonä¾èµ–æ˜¯å¦æ­£ç¡®å®‰è£…")
            print("   2. æ•°æ®æ–‡ä»¶æ˜¯å¦å¯è®¿é—®")
            print("   3. ç³»ç»Ÿæƒé™æ˜¯å¦è¶³å¤Ÿ")
            return False

# =============================================================================
# APIç«¯ç‚¹å®šä¹‰
# åŠŸèƒ½ï¼šæä¾›RESTful APIæ¥å£ï¼Œå¤„ç†å‰ç«¯è¯·æ±‚
# =============================================================================

@app.route('/api/query', methods=['POST'])
def query():
    """
    å¤„ç†ç”¨æˆ·æŸ¥è¯¢è¯·æ±‚çš„APIç«¯ç‚¹

    åŠŸèƒ½ï¼š
    1. æ¥æ”¶å‰ç«¯å‘é€çš„åŒ»ç–—é—®é¢˜
    2. éªŒè¯è¾“å…¥æ•°æ®çš„æœ‰æ•ˆæ€§
    3. è°ƒç”¨RAGç³»ç»Ÿç”Ÿæˆç­”æ¡ˆ
    4. è¿”å›æ ‡å‡†åŒ–çš„JSONå“åº”

    è¯·æ±‚æ ¼å¼ï¼š
        POST /api/query
        Content-Type: application/json
        {
            "question": "é“¶å±‘ç—…ç”Ÿç‰©åˆ¶å‰‚æœ‰å“ªäº›ï¼Ÿ"
        }

    å“åº”æ ¼å¼ï¼š
        æˆåŠŸï¼š
        {
            "success": true,
            "data": {
                "answer": "æ ¹æ®ç›¸å…³åŒ»å­¦æ–‡çŒ®...",
                "sources": [...],
                "query": "é“¶å±‘ç—…ç”Ÿç‰©åˆ¶å‰‚æœ‰å“ªäº›ï¼Ÿ"
            }
        }

        å¤±è´¥ï¼š
        {
            "success": false,
            "error": "é”™è¯¯ä¿¡æ¯"
        }
    """
    try:
        # =============================================================================
        # è¯·æ±‚æ•°æ®è§£æå’ŒéªŒè¯
        # =============================================================================

        # ä»HTTPè¯·æ±‚ä¸­è§£æJSONæ•°æ®
        data = request.get_json()

        # æå–å¹¶æ¸…ç†ç”¨æˆ·é—®é¢˜ï¼ˆå»é™¤é¦–å°¾ç©ºæ ¼ï¼‰
        question = data.get('question', '').strip()

        # è¾“å…¥éªŒè¯ï¼šæ£€æŸ¥é—®é¢˜æ˜¯å¦ä¸ºç©º
        if not question:
            return jsonify({
                'success': False,
                'error': 'é—®é¢˜ä¸èƒ½ä¸ºç©ºï¼Œè¯·è¾“å…¥æ‚¨çš„åŒ»ç–—é—®é¢˜'
            }), 400  # HTTP 400 Bad Request

        # ç³»ç»ŸçŠ¶æ€æ£€æŸ¥ï¼šç¡®ä¿RAGç³»ç»Ÿå·²æ­£ç¡®åˆå§‹åŒ–
        if rag_system is None:
            return jsonify({
                'success': False,
                'error': 'RAGç³»ç»Ÿæœªåˆå§‹åŒ–ï¼Œè¯·æ£€æŸ¥ç³»ç»Ÿé…ç½®'
            }), 500  # HTTP 500 Internal Server Error

        # =============================================================================
        # æ‰§è¡ŒRAGæŸ¥è¯¢
        # =============================================================================

        # è°ƒç”¨RAGç³»ç»Ÿå¤„ç†ç”¨æˆ·é—®é¢˜ï¼Œè¿”å›å‰3ä¸ªæœ€ç›¸å…³çš„æ–‡æ¡£
        result = rag_system.query(question, top_k=3)

        # =============================================================================
        # è¿”å›æˆåŠŸå“åº”
        # =============================================================================

        return jsonify({
            'success': True,
            'data': result
        })

    except Exception as e:
        # =============================================================================
        # å¼‚å¸¸å¤„ç†å’Œé”™è¯¯å“åº”
        # =============================================================================

        # æ•è·æ‰€æœ‰æœªé¢„æœŸçš„å¼‚å¸¸ï¼Œè¿”å›å‹å¥½çš„é”™è¯¯ä¿¡æ¯
        return jsonify({
            'success': False,
            'error': f'æŸ¥è¯¢å¤„ç†å¤±è´¥: {str(e)}'
        }), 500  # HTTP 500 Internal Server Error

@app.route('/api/health', methods=['GET'])
def health_check():
    """
    ç³»ç»Ÿå¥åº·æ£€æŸ¥APIç«¯ç‚¹

    åŠŸèƒ½ï¼š
    1. æ£€æŸ¥ç³»ç»Ÿè¿è¡ŒçŠ¶æ€
    2. éªŒè¯RAGç³»ç»Ÿæ˜¯å¦å·²åˆå§‹åŒ–
    3. æä¾›ç³»ç»Ÿç›‘æ§ä¿¡æ¯

    å“åº”æ ¼å¼ï¼š
    {
        "status": "healthy",
        "rag_initialized": true/false
    }
    """
    return jsonify({
        'status': 'healthy',  # ç³»ç»Ÿè¿è¡ŒçŠ¶æ€
        'rag_initialized': rag_system is not None  # RAGç³»ç»Ÿåˆå§‹åŒ–çŠ¶æ€
    })

@app.route('/api/documents', methods=['GET'])
def get_documents():
    """
    è·å–æ–‡æ¡£ç»Ÿè®¡ä¿¡æ¯çš„APIç«¯ç‚¹

    åŠŸèƒ½ï¼š
    1. è¿”å›ç³»ç»Ÿä¸­åŒ»ç–—æ–‡æ¡£çš„æ€»æ•°é‡
    2. è¿”å›å‘é‡ç´¢å¼•çš„å¤§å°ï¼ˆä»…å®Œæ•´RAGç³»ç»Ÿï¼‰
    3. æä¾›ç³»ç»Ÿæ•°æ®è§„æ¨¡çš„ç»Ÿè®¡ä¿¡æ¯

    å“åº”æ ¼å¼ï¼š
        æˆåŠŸï¼š
        {
            "success": true,
            "data": {
                "total_documents": 25,
                "index_size": 25
            }
        }

        å¤±è´¥ï¼š
        {
            "success": false,
            "error": "é”™è¯¯ä¿¡æ¯"
        }
    """
    # æ£€æŸ¥RAGç³»ç»Ÿæ˜¯å¦å·²åˆå§‹åŒ–
    if rag_system is None:
        return jsonify({
            'success': False,
            'error': 'RAGç³»ç»Ÿæœªåˆå§‹åŒ–ï¼Œæ— æ³•è·å–æ–‡æ¡£ç»Ÿè®¡ä¿¡æ¯'
        }), 500  # HTTP 500 Internal Server Error

    # =============================================================================
    # è·å–ç´¢å¼•å¤§å°ä¿¡æ¯
    # =============================================================================

    # æ ¹æ®RAGç³»ç»Ÿç±»å‹è·å–ä¸åŒçš„ç´¢å¼•å¤§å°
    if hasattr(rag_system, 'index') and rag_system.index:
        # å®Œæ•´RAGç³»ç»Ÿï¼šè¿”å›FAISSå‘é‡ç´¢å¼•çš„å¤§å°
        index_size = rag_system.index.ntotal
    else:
        # ç®€åŒ–RAGç³»ç»Ÿï¼šè¿”å›æ–‡æ¡£æ•°é‡ä½œä¸ºç´¢å¼•å¤§å°
        index_size = len(rag_system.documents)

    # è¿”å›æ–‡æ¡£ç»Ÿè®¡ä¿¡æ¯
    return jsonify({
        'success': True,
        'data': {
            'total_documents': len(rag_system.documents),  # æ€»æ–‡æ¡£æ•°é‡
            'index_size': index_size  # ç´¢å¼•å¤§å°
        }
    })

@app.route('/')
def index():
    """
    ç³»ç»Ÿä¸»é¡µAPIç«¯ç‚¹

    åŠŸèƒ½ï¼š
    1. è¿”å›åŒ»ç–—çŸ¥è¯†RAGç³»ç»Ÿçš„ä¸»é¡µé¢
    2. æä¾›ç”¨æˆ·äº¤äº’ç•Œé¢

    è¿”å›ï¼š
        HTMLé¡µé¢ï¼štemplates/index.html
    """
    return render_template('index.html')

# =============================================================================
# åº”ç”¨å¯åŠ¨å…¥å£
# åŠŸèƒ½ï¼šåˆå§‹åŒ–RAGç³»ç»Ÿå¹¶å¯åŠ¨Flask WebæœåŠ¡å™¨
# =============================================================================

if __name__ == '__main__':
    """
    åº”ç”¨å¯åŠ¨å…¥å£ç‚¹
    
    æ‰§è¡Œæµç¨‹ï¼š
    1. è°ƒç”¨initialize_rag()åˆå§‹åŒ–RAGç³»ç»Ÿ
    2. å¦‚æœåˆå§‹åŒ–æˆåŠŸï¼Œå¯åŠ¨Flask WebæœåŠ¡å™¨
    3. å¦‚æœåˆå§‹åŒ–å¤±è´¥ï¼Œè¾“å‡ºé”™è¯¯ä¿¡æ¯å¹¶é€€å‡º
    
    æœåŠ¡å™¨é…ç½®ï¼š
    - è°ƒè¯•æ¨¡å¼ï¼šå¼€å¯ï¼ˆä¾¿äºå¼€å‘è°ƒè¯•ï¼‰
    - ç›‘å¬åœ°å€ï¼š0.0.0.0ï¼ˆå…è®¸å¤–éƒ¨è®¿é—®ï¼‰
    - ç«¯å£ï¼š5000
    """

    print("ğŸ¥ åŒ»ç–—çŸ¥è¯†RAGç³»ç»Ÿå¯åŠ¨ä¸­...")
    print("=" * 60)

    # åˆå§‹åŒ–RAGç³»ç»Ÿ
    if initialize_rag():
        print("âœ… RAGç³»ç»Ÿåˆå§‹åŒ–æˆåŠŸ")
        print("ğŸš€ æ­£åœ¨å¯åŠ¨Flask WebæœåŠ¡å™¨...")
        print("ğŸ“± è®¿é—®åœ°å€: http://localhost:5000")
        print("â¹ï¸  æŒ‰ Ctrl+C åœæ­¢æœåŠ¡å™¨")
        print("-" * 60)

        # å¯åŠ¨Flaskå¼€å‘æœåŠ¡å™¨
        app.run(
            debug=True,      # å¼€å¯è°ƒè¯•æ¨¡å¼ï¼Œè‡ªåŠ¨é‡è½½ä»£ç 
            host='0.0.0.0',  # ç›‘å¬æ‰€æœ‰ç½‘ç»œæ¥å£
            port=5000        # ä½¿ç”¨5000ç«¯å£
        )
    else:
        print("âŒ RAGç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥")
        print("ğŸ’¡ è¯·æ£€æŸ¥ï¼š")
        print("   1. Pythonä¾èµ–æ˜¯å¦æ­£ç¡®å®‰è£…")
        print("   2. æ•°æ®æ–‡ä»¶æ˜¯å¦å¯è®¿é—®")
        print("   3. æ¨¡å‹è·¯å¾„æ˜¯å¦æ­£ç¡®")
        print("   4. APIå¯†é’¥æ˜¯å¦æœ‰æ•ˆ")
        print("ğŸ”§ æ— æ³•å¯åŠ¨WebæœåŠ¡å™¨") 